<?xml version="1.0" encoding="UTF-8" ?>
<odoo>

    <template id="petit_reports.report_mrprepairorder_travaux">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="o">
                <t t-call="web.external_layout">
                    <t t-set="o" t-value="o.with_context({'lang': o.partner_id.lang})"/>
                    <link rel='stylesheet' href="/petit_reports/static/src/css/style.css"/>
                    <div class="page">
                        <t t-call="petit_reports.report_mrprepair_header_addresse" t-lang="o.partner_id.lang"/>

                        <h2 class="text-center">Rapport d'expertise à réception et avant travaux</h2>

                        <t t-call="petit_reports.report_mrprepair_header_infos" t-lang="o.partner_id.lang"/>

                        <!-- Rapport -->
                        <h3>Synthèse de l'expertise</h3>

                        <!-- Informations sur le probleme -->
                        <h4 t-if="o.issue or o.recommendations">Causes de la panne et recommandations</h4>
                        <div t-if="o.issue">
                            <strong>Causes</strong> : <span t-field="o.issue"/><br />
                        </div>

                        <div t-if="o.recommendations">
                            <strong>Recommandations</strong> : <span t-field="o.recommendations"/>
                        </div>

                        <!-- Tests qui ont echoues -->
                        <h4>Mesures en anomalie</h4>
                        <table class="table table-condensed">
                            <thead>
                                <tr>
                                    <th>N°</th>
                                    <th>Mesure</th>
                                    <th>Norme</th>
                                    <th>Valeur</th>
                                    <th>Unité</th>
                                </tr>
                            </thead>
                            <tbody>
                                <t t-foreach="o.production_id.workorder_ids" t-as="workorder">
                                    <t t-if="workorder.state == 'done'">
                                        <t t-if="workorder.check_ids">
                                            <t t-foreach="workorder.check_ids" t-as="check">
                                                <tr t-if="check.quality_state == 'fail'">
                                                    <td><span t-field="check.point_id.name"/></td>
                                                    <td><span t-field="check.point_id.title"/></td>
                                                    <td><span t-field="check.point_id.norm"/></td>
                                                    <td><span t-field="check.measure"/></td>
                                                    <td><span t-field="check.norm_unit"/></td>
                                                </tr>
                                            </t>
                                        </t>
                                    </t>
                                </t>
                            </tbody>
                        </table>

                        <!-- Pieces -->
                        <div t-if="o.production_id._prepare_materials_for_report() != []">
                            <h4>Pièces à changer</h4>
                            <table class="table table-condensed">
                                <thead>
                                    <tr>
                                        <th>Désignation</th>
                                        <th>Quantité</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <t t-foreach="o.production_id._prepare_materials_for_report()" t-as="piece">
                                        <tr>
                                            <td><span t-esc="piece['pname']"/></td>
                                            <td><span t-esc="piece['qty']"/> <span t-field="piece['uom']"/></td>
                                        </tr>
                                    </t>
                                </tbody>
                            </table>
                        </div>

                        <!-- Liste de toutes les operations -->
                        <h4>Détail des opérations et mesures</h4>
                        <p>Légende : C = Conforme / NC = Non Conforme / NSP = Ne S'applique Pas</p>
                        <t t-foreach="doc.get_workcenters_for_report()" t-as="workcenter">
                            <h3><span t-esc="workcenter"/></h3>
                            <t t-foreach="doc.repair_order_id.production_id._prepare_workorders_for_report()" t-as="workorder">
                                <t t-if="workorder['workcenter'] == workcenter">
                                    <p t-esc="workorder['name']"/>
                                    <t>
                                        <table class="table table-condensed">
                                            <thead>
                                                <tr>
                                                    <th>N°</th>
                                                    <th>Mesure</th>
                                                    <th>Norme</th>
                                                    <th>Valeur</th>
                                                    <th>Unité</th>
                                                    <th>C</th>
                                                    <th>NC</th>
                                                    <th>NSP</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <t t-foreach="workorder['check']" t-as="check">
                                                    <tr>
                                                        <td><span t-esc="check['test_type']"/></td>
                                                        <td><span t-esc="check['title']"/></td>
                                                        <td>
                                                            <span t-esc="check['tolerance_min']"/>
                                                            <span t-esc="check['tolerance_max']"/>
                                                        </td>
                                                        <td><span t-esc="check['measure']"/></td>
                                                        <td><span t-esc="check['norm_unit']"/></td>
                                                        <td><span t-if="check['quality_state']=='pass'" class="text-center">X</span></td>
                                                        <td><span t-if="check['quality_state']=='fail'" class="text-center">X</span></td>
                                                        <td><span t-if="check['quality_state']=='none'" class="text-center">X</span></td>
                                                    </tr>
                                                </t>
                                            </tbody>
                                        </table>
                                    </t>
                                </t>
                            </t>
                        </t>

                        <!-- Photos -->
                        <div class="page_break">
                            <h3 class="text-center">Photos</h3>
                            <h4 class="text-center">Entrée en stock</h4>
                            <t t-foreach="o.attachment_ids" t-as="doc">
                                <t t-if="doc.step == 'entry'">
                                    <img t-if="doc.image" t-att-src="'data:image/png;base64,%s' % to_text(doc.image)" class="image"/>
                                </t>
                            </t>
                        </div>

                        <div class="page_break">
                            <h4 class="text-center">Diagnostic</h4>
                            <t t-foreach="o.attachment_ids" t-as="doc">
                                <t t-if="doc.step == 'diagnostic'">
                                    <img t-if="doc.image" t-att-src="'data:image/png;base64,%s' % to_text(doc.image)" class="image"/>
                                </t>
                            </t>
                        </div>
                    </div>
                </t>
            </t>
        </t>
    </template>

</odoo>