<?xml version="1.0" encoding="UTF-8" ?>
<odoo>

    <!-- Rapport de travaux -->
    <template id="petit_reports.report_mrprepairorder_expertise">

        <t t-call="web.html_container">
            <div class="footer"/>
            <t t-foreach="docs" t-as="o">
                <t t-call="web.external_layout">
                    <t t-set="o" t-value="o.with_context({'lang': o.partner_id.lang})"/>
                    <link rel='stylesheet' href="/petit_reports/static/src/css/style.css"/>
                    <div class="page">

                        <t t-call="petit_reports.report_mrprepair_header_addresse" t-lang="o.partner_id.lang"/>

                        <t t-call="petit_reports.report_mrprepair_header_infos" t-lang="o.partner_id.lang"/>


                        <div class="page_break">
                            <!-- Rapport -->
                            <p/>
                        </div>


                        <!-- Recap de toutes les operations -->
                        <div class="page_break">
                            <t t-if="o.get_workcenters_for_report() != []">
                                <h4>Détail des opérations et mesures</h4>
                                <p>Légende : C = Conforme / NC = Non Conforme / NSP = Ne S'applique Pas</p>
                                <br />
                                <t t-foreach="o.get_workcenters_for_report()" t-as="workcenter">
                                    <h5><span t-esc="workcenter"/></h5>
                                    <t t-foreach="o.production_id._prepare_workorders_for_report()" t-as="workorder">
                                        <t t-if="workorder['workcenter'] == workcenter and workorder['state'] == 'done'">
                                            <p t-esc="workorder['name']"/>
                                            <t>
                                                <table class="table table-condensed" t-if="workorder.get('quality_check') != []">
                                                    <thead>
                                                        <tr>
                                                            <th>Mesure</th>
                                                            <th>Norme</th>
                                                            <th>Valeur</th>
                                                            <th>Unité</th>
                                                            <th>C</th>
                                                            <th>NC</th>
                                                            <th>NSP</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <t t-foreach="workorder.get('quality_check')" t-as="check">
                                                            <tr t-if="check['test_type'] != 'picture'">
                                                                <td><span t-esc="check['title']"/></td>

                                                                <td t-if="check['test_type'] == 'measure'">
                                                                    Min : <span t-esc="check['tolerance_min']"/>
                                                                    / Max :<span t-esc="check['tolerance_max']"/>
                                                                </td>
                                                                <td t-else="">
                                                                </td>

                                                                <td><span t-if="check['test_type'] == 'measure'" t-esc="check['measure']"/></td>
                                                                <td><span t-if="check['test_type'] == 'measure'" t-esc="check['norm_unit']"/></td>
                                                                <td><span t-if="check.get('state')=='pass'" class="text-center">X</span></td>
                                                                <td><span t-if="check.get('state')=='fail'" class="text-center">X</span></td>
                                                                <td><span t-if="check.get('state')=='none'" class="text-center">X</span></td>
                                                            </tr>
                                                        </t>
                                                    </tbody>
                                                </table>
                                            </t>
                                        </t>
                                    </t>
                                </t>
                            </t>
                        </div>

                        <!-- Informations sur le probleme -->
                        <br />

                        <div t-if="o.recommendations">
                            <strong>Constatation</strong> : <span t-field="o.recommendations"/>
                        </div>

                        <!-- Pieces -->
                        <div t-if="o.production_id._prepare_materials_for_report() != []">
                            <h4>Pièces à changer</h4>
                            <table class="table table-condensed">
                                <thead>
                                    <tr>
                                        <th>Désignation</th>
                                        <th>Quantité</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <t t-foreach="o.production_id._prepare_materials_for_report()" t-as="piece">
                                        <tr>
                                            <td><span t-esc="piece['pname']"/></td>
                                            <td><span t-esc="piece['qty']"/> <span t-esc="piece['uom']"/></td>
                                        </tr>
                                    </t>
                                </tbody>
                            </table>
                        </div>

                        <!-- Photos -->
                        <t t-set="data" t-value="o.get_attachments()"/>
                        <t t-foreach="data" t-as="step">

                            <div t-if="step != 'undefined'">
                                <div class="page_break">
                                    <h2 class="text-left"><strong><span t-esc="step"/></strong></h2>
                                    <div class="row">
                                        <t t-foreach="data[step]" t-as="attachment">
                                            <div class="col-xs-6">

                                                <img class="img-thumbnail" t-att-src="'/web/content/%s?download=true' % (attachment.id)"/>

                                                <h4 t-if="attachment.reference"><t t-esc="attachment.reference"/></h4>
                                                <h4 t-else=""><t t-esc="attachment.name"/></h4>
                                                <t t-esc="attachment.tag_ids.to_string()"/>

                                            </div>
                                        </t>
                                    </div>
                                </div>
                            </div>

                        </t>

                    </div>
                </t>
            </t>

        </t>
    </template>

</odoo>